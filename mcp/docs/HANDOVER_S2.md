# geo-base ã‚»ã‚«ãƒ³ãƒ‰ã‚·ãƒ¼ã‚ºãƒ³ å¼•ãç¶™ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## MCPã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½æ‹¡å……ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

**æœ€çµ‚æ›´æ–°**: 2025-12-14  
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: geo-base MCP Server Enhancement  
**ãƒ•ã‚§ãƒ¼ã‚º**: ã‚»ã‚«ãƒ³ãƒ‰ã‚·ãƒ¼ã‚ºãƒ³æº–å‚™å®Œäº†

---

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### 1.1 ç›®çš„

geo-base MCPã‚µãƒ¼ãƒãƒ¼ã®æ©Ÿèƒ½ã‚’æ‹¡å……ã—ã€ä»¥ä¸‹ã‚’å®Ÿç¾ã™ã‚‹ï¼š

- **æœ€é‡è¦ã‚´ãƒ¼ãƒ«**: `tool_analyze_area`ï¼ˆç©ºé–“åˆ†æãƒ„ãƒ¼ãƒ«ï¼‰ã®å®Ÿè£…
- ä¿å®ˆé‹ç”¨æ€§ã®å‘ä¸Šï¼ˆãƒ­ã‚®ãƒ³ã‚°ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
- æ–°è¦ãƒ„ãƒ¼ãƒ«ã®è¿½åŠ ã«ã‚ˆã‚‹æ©Ÿèƒ½æ‹¡å……
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å‘ä¸Š

### 1.2 é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | èª¬æ˜ |
|-------------|------|
| [MCP_ROADMAP_S2.md](./MCP_ROADMAP_S2.md) | ã‚»ã‚«ãƒ³ãƒ‰ã‚·ãƒ¼ã‚ºãƒ³ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ— |
| [MCP_BEST_PRACTICES.md](./MCP_BEST_PRACTICES.md) | MCPã‚µãƒ¼ãƒãƒ¼é–‹ç™ºã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ |
| [MCP_PRESENTATION.md](./MCP_PRESENTATION.md) | ãƒ—ãƒ¬ã‚¼ãƒ³ç”¨ã‚·ãƒŠãƒªã‚ª |
| [HANDOVER.md](./HANDOVER.md) | ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³ã®å¼•ãç¶™ã |

### 1.3 ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±

| é …ç›® | å€¤ |
|------|-----|
| ãƒªãƒã‚¸ãƒˆãƒª | https://github.com/mopinfish/geo-base |
| å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | `/mcp` |
| ç¾è¡ŒMCPãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 0.2.0 |
| ç›®æ¨™ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 1.0.0 |
| APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 0.4.0 |

---

## 2. ç¾åœ¨ã®çŠ¶æ³

### 2.1 ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | URL |
|---------------|-----------|-----|
| API Server | âœ… ç¨¼åƒä¸­ | https://geo-base-puce.vercel.app |
| MCP Server | âœ… ç¨¼åƒä¸­ | https://geo-base-mcp.fly.dev |
| Admin UI | âœ… ç¨¼åƒä¸­ | https://geo-base-admin.vercel.app |

### 2.2 å®Ÿè£…æ¸ˆã¿ãƒ„ãƒ¼ãƒ«ï¼ˆ16å€‹ï¼‰

```
ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆé–¢é€£ï¼ˆ3ãƒ„ãƒ¼ãƒ«ï¼‰
â”œâ”€â”€ tool_list_tilesets      - ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆä¸€è¦§å–å¾—
â”œâ”€â”€ tool_get_tileset        - ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆè©³ç´°å–å¾—
â””â”€â”€ tool_get_tileset_tilejson - TileJSONå–å¾—

ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼é–¢é€£ï¼ˆ2ãƒ„ãƒ¼ãƒ«ï¼‰
â”œâ”€â”€ tool_search_features    - ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼æ¤œç´¢
â””â”€â”€ tool_get_feature        - ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼è©³ç´°å–å¾—

ã‚¿ã‚¤ãƒ«é–¢é€£ï¼ˆ1ãƒ„ãƒ¼ãƒ«ï¼‰
â””â”€â”€ tool_get_tile_url       - ã‚¿ã‚¤ãƒ«URLç”Ÿæˆ

ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆ2ãƒ„ãƒ¼ãƒ«ï¼‰
â”œâ”€â”€ tool_health_check       - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
â””â”€â”€ tool_get_server_info    - ã‚µãƒ¼ãƒãƒ¼æƒ…å ±å–å¾—

ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆ2ãƒ„ãƒ¼ãƒ«ï¼‰
â”œâ”€â”€ tool_geocode            - ä½æ‰€â†’åº§æ¨™å¤‰æ›
â””â”€â”€ tool_reverse_geocode    - åº§æ¨™â†’ä½æ‰€å¤‰æ›

CRUDæ“ä½œï¼ˆ6ãƒ„ãƒ¼ãƒ«ï¼‰
â”œâ”€â”€ tool_create_tileset     - ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆä½œæˆ
â”œâ”€â”€ tool_update_tileset     - ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆæ›´æ–°
â”œâ”€â”€ tool_delete_tileset     - ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆå‰Šé™¤
â”œâ”€â”€ tool_create_feature     - ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ä½œæˆ
â”œâ”€â”€ tool_update_feature     - ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼æ›´æ–°
â””â”€â”€ tool_delete_feature     - ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼å‰Šé™¤
```

### 2.3 ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
mcp/
â”œâ”€â”€ server.py              # FastMCPã‚µãƒ¼ãƒãƒ¼æœ¬ä½“
â”œâ”€â”€ config.py              # è¨­å®šç®¡ç†
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ tilesets.py        # ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆé–¢é€£
â”‚   â”œâ”€â”€ features.py        # ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼é–¢é€£
â”‚   â”œâ”€â”€ geocoding.py       # ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
â”‚   â””â”€â”€ crud.py            # CRUDæ“ä½œ
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py
â”‚   â”œâ”€â”€ test_tools.py
â”‚   â”œâ”€â”€ test_geocoding.py
â”‚   â”œâ”€â”€ test_crud.py
â”‚   â””â”€â”€ live_test.py
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ fly.toml
â”œâ”€â”€ pyproject.toml
â””â”€â”€ uv.lock
```

---

## 3. é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºé€²æ—

### Phase 1: åŸºç›¤å¼·åŒ–

| Step | å†…å®¹ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æ‹…å½“ | å‚™è€ƒ |
|------|------|-----------|------|------|
| 2.5-A | ãƒ­ã‚®ãƒ³ã‚°åŸºç›¤ã®è¿½åŠ  | ğŸ”² æœªç€æ‰‹ | - | logger.pyä½œæˆ |
| 2.5-B | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒªãƒˆãƒ©ã‚¤ | ğŸ”² æœªç€æ‰‹ | - | errors.py, retry.pyä½œæˆ |

### Phase 2: æ©Ÿèƒ½æ‹¡å……

| Step | å†…å®¹ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æ‹…å½“ | å‚™è€ƒ |
|------|------|-----------|------|------|
| 2.5-C | çµ±è¨ˆãƒ„ãƒ¼ãƒ«ã®è¿½åŠ  | ğŸ”² æœªç€æ‰‹ | - | tools/stats.pyä½œæˆ |
| 2.5-D | ç©ºé–“åˆ†æãƒ„ãƒ¼ãƒ«ã®è¿½åŠ  | ğŸ”² æœªç€æ‰‹ | - | **æœ€é‡è¦ã‚´ãƒ¼ãƒ«** tools/analysis.pyä½œæˆ |

### Phase 3: å“è³ªå‘ä¸Š

| Step | å†…å®¹ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æ‹…å½“ | å‚™è€ƒ |
|------|------|-----------|------|------|
| 2.5-E | å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ– | ğŸ”² æœªç€æ‰‹ | - | validators.pyä½œæˆ |
| 2.5-F | ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®æ‹¡å…… | ğŸ”² æœªç€æ‰‹ | - | ã‚«ãƒãƒ¬ãƒƒã‚¸80%ç›®æ¨™ |

**å‡¡ä¾‹**: âœ… å®Œäº† | ğŸ”„ é€²è¡Œä¸­ | ğŸ”² æœªç€æ‰‹ | â¸ï¸ ä¿ç•™

---

## 4. æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### 4.1 å³åº§ã«ç€æ‰‹å¯èƒ½ãªã‚¿ã‚¹ã‚¯

1. **Step 2.5-A: ãƒ­ã‚®ãƒ³ã‚°åŸºç›¤ã®è¿½åŠ **
   - [ ] `mcp/logger.py` ã‚’ä½œæˆ
   - [ ] å„ãƒ„ãƒ¼ãƒ«ã«ãƒ­ã‚®ãƒ³ã‚°ã‚’è¿½åŠ 
   - [ ] ç’°å¢ƒå¤‰æ•° `LOG_LEVEL` å¯¾å¿œ

2. **Step 2.5-B: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**
   - [ ] `mcp/errors.py` ã‚’ä½œæˆï¼ˆã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ï¼‰
   - [ ] `mcp/retry.py` ã‚’ä½œæˆï¼ˆtenacityå°å…¥ï¼‰
   - [ ] pyproject.toml ã« tenacity ã‚’è¿½åŠ 

### 4.2 ä¾å­˜é–¢ä¿‚ã®è¿½åŠ äºˆå®š

```toml
# pyproject.toml ã«è¿½åŠ 
dependencies = [
    # æ—¢å­˜
    "fastmcp>=0.1.0",
    "httpx>=0.25.0",
    "python-dotenv>=1.0.0",
    # æ–°è¦è¿½åŠ 
    "tenacity>=8.0.0",
]
```

---

## 5. æŠ€è¡“çš„ãªãƒ¡ãƒ¢

### 5.1 ãƒ­ã‚®ãƒ³ã‚°å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
# mcp/logger.py
import logging
import os

def setup_logger(name: str) -> logging.Logger:
    logger = logging.getLogger(name)
    log_level = os.environ.get("LOG_LEVEL", "INFO").upper()
    logger.setLevel(getattr(logging, log_level, logging.INFO))
    
    handler = logging.StreamHandler()
    formatter = logging.Formatter(
        "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    )
    handler.setFormatter(formatter)
    logger.addHandler(handler)
    
    return logger
```

### 5.2 ãƒªãƒˆãƒ©ã‚¤å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
# mcp/retry.py
from tenacity import (
    retry,
    stop_after_attempt,
    wait_exponential,
    retry_if_exception_type,
)
import httpx

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=1, max=10),
    retry=retry_if_exception_type((httpx.TimeoutException, httpx.NetworkError)),
)
async def fetch_with_retry(url: str, params: dict | None = None) -> dict:
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.get(url, params=params)
        response.raise_for_status()
        return response.json()
```

### 5.3 tool_analyze_area è¨­è¨ˆæ¡ˆ

```python
@mcp.tool()
async def tool_analyze_area(
    bbox: str,
    tileset_id: str | None = None,
    analysis_type: str = "summary",
) -> dict:
    """
    æŒ‡å®šç¯„å›²å†…ã®åœ°ç†ç©ºé–“ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æ
    
    Args:
        bbox: ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ "minx,miny,maxx,maxy" (WGS84)
        tileset_id: åˆ†æå¯¾è±¡ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆID
        analysis_type: "summary" | "density" | "distribution" | "full"
    
    Returns:
        {
            "bbox": {...},
            "area_km2": 12.5,
            "feature_count": 150,
            "geometry_distribution": {
                "Point": 100,
                "LineString": 30,
                "Polygon": 20
            },
            "density": {
                "features_per_km2": 12.0
            },
            "layers": ["default", "buildings", "roads"]
        }
    """
```

---

## 6. æ—¢çŸ¥ã®å•é¡Œãƒ»æ³¨æ„ç‚¹

### 6.1 åˆ¶é™äº‹é …

| é …ç›® | è©³ç´° |
|------|------|
| Vercelç’°å¢ƒ | rasterioãŒä½¿ç”¨ä¸å¯ï¼ˆGDALä¾å­˜ï¼‰ |
| PMTiles | èª­ã¿å–ã‚Šã®ã¿å¯¾å¿œï¼ˆæ›¸ãè¾¼ã¿æœªå¯¾å¿œï¼‰ |
| èªè¨¼ | API_TOKENãŒå¿…é ˆã®CRUDæ“ä½œã‚ã‚Š |

### 6.2 ç’°å¢ƒå¤‰æ•°

```bash
# å¿…é ˆ
TILE_SERVER_URL=https://geo-base-puce.vercel.app

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³
API_TOKEN=xxxxx           # CRUDæ“ä½œã«å¿…è¦
LOG_LEVEL=INFO            # DEBUG, INFO, WARNING, ERROR
MCP_TRANSPORT=stdio       # stdio, sse, streamable-http
MCP_HOST=0.0.0.0          # SSE/HTTPæ™‚ã®ãƒ›ã‚¹ãƒˆ
MCP_PORT=8080             # SSE/HTTPæ™‚ã®ãƒãƒ¼ãƒˆ
```

---

## 7. å‚è€ƒè³‡æ–™

### 7.1 ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ·»ä»˜ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ |
|---------|------|
| quickstart-resources.txt | Anthropicå…¬å¼ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ |
| openweather-mcp.txt | å¤©æ°—äºˆå ±MCPã‚µãƒ¼ãƒãƒ¼ |
| chillax-mcp-server.txt | éã”ã—æ–¹ææ¡ˆMCPã‚µãƒ¼ãƒãƒ¼ |
| documentor.txt | ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢MCPã‚µãƒ¼ãƒãƒ¼ |

### 7.2 å¤–éƒ¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [FastMCP GitHub](https://github.com/jlowin/fastmcp)
- [Model Context Protocol](https://modelcontextprotocol.io/)
- [tenacity Documentation](https://tenacity.readthedocs.io/)

---

## 8. é€£çµ¡å…ˆãƒ»è³ªå•

ä½œæ¥­ã‚’å†é–‹ã™ã‚‹éš›ã¯ã€ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ [MCP_ROADMAP_S2.md](./MCP_ROADMAP_S2.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | å†…å®¹ | æ‹…å½“ |
|------|------|------|
| 2025-12-14 | åˆç‰ˆä½œæˆï¼ˆã‚»ã‚«ãƒ³ãƒ‰ã‚·ãƒ¼ã‚ºãƒ³æº–å‚™ï¼‰ | Claude |
