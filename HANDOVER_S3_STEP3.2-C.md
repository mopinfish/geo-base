# geo-base Season 3 å¼•ãç¶™ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - Step 3.2-C

**æ›´æ–°æ—¥**: 2025-12-17  
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: geo-base - åœ°ç†ç©ºé–“ã‚¿ã‚¤ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚·ã‚¹ãƒ†ãƒ   
**ãƒªãƒã‚¸ãƒˆãƒª**: https://github.com/mopinfish/geo-base  
**ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ**: `develop`

---

## 1. ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³

### 1.1 ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | URL | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|---------------|-----------|-----|-----------|
| API Server (Fly.io) | âœ… ç¨¼åƒä¸­ | https://geo-base-api.fly.dev | 0.4.2 â†’ **0.4.3** |
| MCP Server (Fly.io) | âœ… ç¨¼åƒä¸­ | https://geo-base-mcp.fly.dev | 0.2.5 |
| Admin UI (Vercel) | âœ… ç¨¼åƒä¸­ | https://geo-base-admin.vercel.app | 0.4.0 |

### 1.2 Season 3 é€²æ—ã‚µãƒãƒªãƒ¼

| ãƒ•ã‚§ãƒ¼ã‚º | ã‚¹ãƒ†ãƒƒãƒ— | å†…å®¹ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|---------|---------|------|-----------|
| Phase 1 | Step 3.1-A~E | Fly.ioç§»è¡Œãƒ»COG/ãƒ©ã‚¹ã‚¿ãƒ¼ã‚µãƒãƒ¼ãƒˆ | âœ… å®Œäº† |
| Phase 2 | Step 3.2-A | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ– | âœ… å®Œäº† |
| Phase 2 | Step 3.2-B | ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½çµ±åˆ | âœ… å®Œäº† |
| **Phase 2** | **Step 3.2-C** | **Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥å°å…¥** | âœ… **å®Œäº†** |
| Phase 2 | Step 3.2-D | ãƒãƒƒãƒå‡¦ç†æœ€é©åŒ– | ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— |

---

## 2. ä»Šå›å®Œäº†ã—ãŸä½œæ¥­: Step 3.2-C Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥å°å…¥

### 2.1 æ¦‚è¦

Redisã‚’ä½¿ç”¨ã—ãŸã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã¾ã—ãŸã€‚
RedisãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹è¨­è¨ˆã§ã™ã€‚

### 2.2 å®Ÿè£…å†…å®¹

#### Step 3.2-C.1: Redisã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `api/lib/redis_client.py` (~500è¡Œ)

æ©Ÿèƒ½:
- `RedisConfig`: ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®è¨­å®šèª­ã¿è¾¼ã¿
- `get_redis()`: Redisã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå–å¾—ï¼ˆé…å»¶åˆæœŸåŒ–ï¼‰
- `redis_available()`: Redisæ¥ç¶šç¢ºèª
- `safe_redis_get/set/delete()`: å®‰å…¨ãªæ“ä½œï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯Noneè¿”å´ï¼‰
- `redis_get_json/set_json()`: JSONæ“ä½œ
- `redis_get_binary/set_binary()`: ãƒã‚¤ãƒŠãƒªæ“ä½œï¼ˆã‚¿ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
- `check_redis_health()`: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- `get_redis_stats()`: çµ±è¨ˆæƒ…å ±å–å¾—

#### Step 3.2-C.2: ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `api/lib/tile_cache.py` (~600è¡Œ)

æ©Ÿèƒ½:
- `TileCacheConfig`: ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
- `get_cached_tile() / cache_tile()`: ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- `get_cached_tilejson() / cache_tilejson()`: TileJSONã‚­ãƒ£ãƒƒã‚·ãƒ¥
- `get_cached_tileset_info() / cache_tileset_info()`: ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆæƒ…å ±ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- `invalidate_tileset()`: ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆå˜ä½ã®ç„¡åŠ¹åŒ–
- `invalidate_tile()`: å€‹åˆ¥ã‚¿ã‚¤ãƒ«ã®ç„¡åŠ¹åŒ–
- `clear_all_tile_caches()`: å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
- `get_tile_cache_stats()`: çµ±è¨ˆæƒ…å ±

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³:
```
tile:vector:{tileset_id}:{z}:{x}:{y}[:layer:{name}]
tile:raster:{tileset_id}:{z}:{x}:{y}[:cmap:{colormap}][:bands:{bands}]
tile:pmtiles:{tileset_id}:{z}:{x}:{y}
tilejson:{type}:{tileset_id}
tileset:{tileset_id}
```

#### Step 3.2-C.3: Docker Composeè¨­å®š

**æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«**: `docker/docker-compose.yml`

æ—¢å­˜ã®PostgreSQLè¨­å®šã«Redisã‚’è¿½åŠ :
- `redis`: Redis 7 Alpine
- `redis-commander`: Web UIï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€`--profile tools`ã§èµ·å‹•ï¼‰
- `redis_data`: æ°¸ç¶šåŒ–ãƒœãƒªãƒ¥ãƒ¼ãƒ 

#### Step 3.2-C.4: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `docs/REDIS_SETUP.md`

å†…å®¹:
- ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- æœ¬ç•ªç’°å¢ƒï¼ˆFly.ioï¼‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- Upstash Redisï¼ˆä»£æ›¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- ç’°å¢ƒå¤‰æ•°ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

### 2.3 ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆæ•° | å†…å®¹ |
|---------|---------|------|
| `test_redis_client.py` | 25 | Redisã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ |
| `test_tile_cache.py` | 21 | ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆ |

**æ–°è¦ãƒ†ã‚¹ãƒˆåˆè¨ˆ**: 46ãƒ†ã‚¹ãƒˆ

### 2.4 ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Request                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    tile_cache.py                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  get_cached_*()  â”‚  â”‚    cache_*()     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚
            â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Redis Cache       â”‚  â”‚   Memory Cache        â”‚
â”‚   (redis_client.py)   â”‚  â”‚   (TTLCache)          â”‚
â”‚                       â”‚  â”‚   - Fallback          â”‚
â”‚   - Primary           â”‚  â”‚   - Fast access       â”‚
â”‚   - Distributed       â”‚  â”‚   - Single instance   â”‚
â”‚   - Persistent        â”‚  â”‚   - Non-persistent    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ç’°å¢ƒè¨­å®š

### 3.1 ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º

```fish
# ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ï¼ˆdocker/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ï¼‰
cd docker
docker compose up -d

# ã¾ãŸã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰
docker compose -f docker/docker-compose.yml up -d

# ç’°å¢ƒå¤‰æ•°è¨­å®š
set -x REDIS_ENABLED true
set -x REDIS_HOST localhost
set -x REDIS_PORT 6379

# APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
cd api
uv run uvicorn main:app --reload --port 8080
```

### 3.2 æœ¬ç•ªç’°å¢ƒ (Fly.io)

```fish
# Fly.io Redisä½œæˆ
fly redis create

# ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š
fly secrets set REDIS_URL="redis://..."

# ãƒ‡ãƒ—ãƒ­ã‚¤
fly deploy
```

è©³ç´°ã¯ `docs/REDIS_SETUP.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## 4. ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### è¿½åŠ ãƒ»æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«

```
api/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ redis_client.py       # æ–°è¦ (500è¡Œ) - Redisã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â””â”€â”€ tile_cache.py         # æ–°è¦ (600è¡Œ) - ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
â””â”€â”€ tests/
    â”œâ”€â”€ test_redis_client.py  # æ–°è¦ (250è¡Œ) - Redisãƒ†ã‚¹ãƒˆ
    â””â”€â”€ test_tile_cache.py    # æ–°è¦ (300è¡Œ) - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆ

docker/
â””â”€â”€ docker-compose.yml        # æ›´æ–° - Redisã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ 

docs/
â””â”€â”€ REDIS_SETUP.md            # æ–°è¦ - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰
```

**åˆè¨ˆ**: ç´„1,650è¡Œã®æ–°è¦ã‚³ãƒ¼ãƒ‰ã€46ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

---

## 5. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```fish
cd api

# å…¨ãƒ†ã‚¹ãƒˆ
uv run pytest tests/ -v

# Redisé–¢é€£ã®ã¿
uv run pytest tests/test_redis_client.py tests/test_tile_cache.py -v
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**: 126 passed

---

## 6. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: Step 3.2-D ãƒãƒƒãƒå‡¦ç†æœ€é©åŒ–

### 6.1 è¨ˆç”»å†…å®¹

1. **ãƒãƒ«ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½**
   - GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
   - Shapefileã‹ã‚‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆAPIã‚­ãƒ£ãƒƒã‚·ãƒ¥
   - é€²æ—é€šçŸ¥

2. **ãƒãƒ«ã‚¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½**
   - ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆå…¨ä½“ã®GeoJSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
   - ãƒ•ã‚£ãƒ«ã‚¿ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

3. **ãƒãƒƒãƒæ›´æ–°æ©Ÿèƒ½**
   - è¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã®ä¸€æ‹¬æ›´æ–°
   - æ¡ä»¶ä»˜ãä¸€æ‹¬å‰Šé™¤

### 6.2 è¦‹ç©ã‚‚ã‚Š

| ã‚¿ã‚¹ã‚¯ | è¦‹ç©ã‚‚ã‚Š |
|--------|----------|
| ãƒãƒ«ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆAPI | 1.5æ—¥ |
| ãƒãƒ«ã‚¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆAPI | 1æ—¥ |
| ãƒãƒƒãƒæ›´æ–°API | 1æ—¥ |
| ãƒ†ã‚¹ãƒˆ | 0.5æ—¥ |

---

## 7. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

```fish
cd /path/to/geo-base

# zipã‚’è§£å‡ã—ã¦ä¸Šæ›¸ã
unzip -o ~/Downloads/geo-base-step3.2-C.zip -d .

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç¢ºèª
cd api
uv run pytest tests/ -v

# ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
cd ..
git add .
git commit -m "feat(api): Step 3.2-C - Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥å°å…¥

Step 3.2-C.1: Redisã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- api/lib/redis_client.py: æ¥ç¶šç®¡ç†ã€å®‰å…¨ãªæ“ä½œ
- ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹è¨­å®šã€graceful degradation

Step 3.2-C.2: ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- api/lib/tile_cache.py: ã‚¿ã‚¤ãƒ«/TileJSON/ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆæƒ…å ±ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- Redis + ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰è¨­è¨ˆ

Step 3.2-C.3: é–‹ç™ºç’°å¢ƒ
- docker/docker-compose.yml: Redisã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ 
- docs/REDIS_SETUP.md: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰:
- api/tests/test_redis_client.py: 25ãƒ†ã‚¹ãƒˆ
- api/tests/test_tile_cache.py: 21ãƒ†ã‚¹ãƒˆ
- åˆè¨ˆ46ãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆç·æ•°126ãƒ†ã‚¹ãƒˆï¼‰"

git push origin develop
```

---

## 8. å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|---------|------|
| `docs/REDIS_SETUP.md` | Redisã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ |
| `HANDOVER_S3_STEP3.2-B.md` | å‰å›ã®å¼•ãç¶™ã |
| `ROADMAP_S3.md` | Season 3ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ— |

### å¤–éƒ¨å‚è€ƒ

- [Redis Documentation](https://redis.io/docs/)
- [redis-py](https://redis-py.readthedocs.io/)
- [Fly.io Redis](https://fly.io/docs/reference/redis/)
- [Upstash Redis](https://upstash.com/docs/redis/)

---

**ä½œæˆè€…**: Claude (Anthropic)  
**å®Œäº†æ—¥**: 2025-12-17  
**æ¬¡å›ä½œæ¥­**: Phase 2 Step 3.2-Dï¼ˆãƒãƒƒãƒå‡¦ç†æœ€é©åŒ–ï¼‰
